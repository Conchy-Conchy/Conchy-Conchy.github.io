<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  CH001 Typora Mermaid Incompatibility · Conchy&#39;s house
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Xin Xiong">
<meta name="description" content="Solution to showing “Painting Diagram…” in Typora for macOS Catalina">
<meta name="keywords" content="blog,developer,personal">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CH001 Typora Mermaid Incompatibility">
  <meta name="twitter:description" content="Solution to showing “Painting Diagram…” in Typora for macOS Catalina">

<meta property="og:url" content="http://localhost:1313/posts/catalinaholdout/001typoramermaid/001typoramermaid/">
  <meta property="og:site_name" content="Conchy&#39;s house">
  <meta property="og:title" content="CH001 Typora Mermaid Incompatibility">
  <meta property="og:description" content="Solution to showing “Painting Diagram…” in Typora for macOS Catalina">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-22T22:03:50+08:00">
    <meta property="article:modified_time" content="2024-05-22T22:03:50+08:00">
    <meta property="article:tag" content="MacOS">
      <meta property="og:see_also" content="http://localhost:1313/posts/catalinaholdout/000intro/">




<link rel="canonical" href="http://localhost:1313/posts/catalinaholdout/001typoramermaid/001typoramermaid/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/svg+xml" href="/img/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Conchy&#39;s house
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/catalinaholdout/001typoramermaid/001typoramermaid/">
              CH001 Typora Mermaid Incompatibility
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-05-22T22:03:50&#43;08:00">
                May 22, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              5-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/catalinaholdout/">CatalinaHoldout</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/macos/">MacOS</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="tldr">
  TL;DR
  <a class="heading-link" href="#tldr">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Recently, when drawing graphs with mermaid in Typora 1.8.10, it’s always showing “Painting Diagram…” and stuck forever. The problem doesn’t happen for other diagram renderers, namely, Flowchart and Sequence. It also works fine for <em>modern</em> macOS like Sonoma.</p>
<p>When I visit the official website, I finds that the latest recommended version for macOS Catalina is 1.4.8, and the version does work fine.As someone who relies on Typora pretty heavily and do not get away from the excellent new features like alert boxes, I decided to dive into this problem.</p>
<p>Today, I spent the whole afternoon for debugging, with quite a few times quitting (==). For somebody who is not familiar with javascript, debugging one <code>.js</code>  file with everything in one line is quite challenging.</p>
<h2 id="debugging-process">
  Debugging process
  <a class="heading-link" href="#debugging-process">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="debugging-mode-of-typora">
  Debugging mode of Typora
  <a class="heading-link" href="#debugging-mode-of-typora">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>It doesn’t take long before making use of the debugging mode of Typora. One can enable debugging mode in the <code>Help</code> menubar, and then right click the editor panel, select <code>Inspect Element</code>, a safari workspace(?) would pop up. But as a neophyte to safari developer mode, this is almost playing with fire. At first, I only search strings like <code>mermaid</code> , and it seems that most occurrences are in <code>main.js</code>  and <code>mermaid.min.js</code>.</p>
<h3 id="js-formulating-plugin-for-vscode">
  JS Formulating plugin for VSCode
  <a class="heading-link" href="#js-formulating-plugin-for-vscode">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>To save space, most javascript is compressed to one line, which is deteriorating for human reading. Fortunately, there are some formulating tools and plugins to do the trick. I uses <a href="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode"  class="external-link" target="_blank" rel="noopener"><code>Prettier-Code formatter</code></a>. It would transform the code into human readable formats, really good for my eyes…</p>
<h3 id="typeerror-in-mainjs">
  TypeError in main.js
  <a class="heading-link" href="#typeerror-in-mainjs">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>For programmers whose life revolves around debugging, instincts tell me to find the log console. Fortunately, it can be accessed easily through the <code>Console</code> in the safari workspace. Searching for <code>mermaid</code> , and I gets a <code>TypeError: undefined is not an object (evaluating ‘window.mermaid.registerExternalDiagrams’)</code>.  And this message points to lines in a function named <code>lazyload</code> in <code>main.js</code>. Wow, this seems interesting!</p>
<div class="highlight"><pre tabindex="0" style="color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>                    <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#ff7b72">var</span> n <span style="color:#ff7b72;font-weight:bold">=</span> File.isNode <span style="color:#ff7b72;font-weight:bold">?</span> <span style="color:#a5d6ff">&#34;./lib.asar&#34;</span> <span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;./lib&#34;</span>;
</span></span><span style="display:flex;"><span>                        s.getScript(n <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">&#34;/diagram/diagram.min.js&#34;</span>, <span style="color:#ff7b72">function</span>() {
</span></span><span style="display:flex;"><span>                            s.getScript(n <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">&#34;/diagram/mermaid.min.js&#34;</span>, <span style="color:#ff7b72">function</span>() {
</span></span><span style="display:flex;"><span>                                s.getScript(n <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">&#34;/diagram/mermaid-zenuml.min.js&#34;</span>, <span style="color:#ff7b72">function</span>() {
</span></span><span style="display:flex;"><span>                                    window.mermaid.registerExternalDiagrams([window[<span style="color:#a5d6ff">&#34;mermaid-zenuml&#34;</span>]]), i()
</span></span><span style="display:flex;"><span>                                })
</span></span><span style="display:flex;"><span>                            })
</span></span><span style="display:flex;"><span>                        })
</span></span><span style="display:flex;"><span>                    }
</span></span></code></pre></div><p>The above message resembles null dereference which I normally deal with. The next step would be printing or intercepting the value at the run time. Unfortunately, this <code>lazyload()</code> function actually only invoked during loading. And for now, loading always precedes me accessing  <code>Inspect Element</code>. I stuck here for quite a while.</p>
<p>What saves me from the coundrum is the discovery of <code>Scope Chain</code> in the <code>Source</code> panel of the safari workspace. The window looks very similar to the <code>watching variables</code> panel in vscode. And it does show the variables!!! After inspection, I finds that the runtime <code>window</code> is legit, but it does not have a member named <code>mermaid</code>. Interestingly, <code>window</code> even has a child named <code>mermaid-zenuml</code>.</p>
<p>Thanks to the similarity between javascript and C lang, I can almost read the code. It seems that it is trying to load scripts from <code>lib/diagram/{diagram,mermaid,mermaid-zenuml}.min.js</code>, and then register hooks through <code>window.mermaid.registerExternalDiagrams()</code>. Since the imports should be in order, there must be something wrong in the <code>lib/diagram/mermaid.min.js</code>.</p>
<h3 id="demon-shows-up">
  Demon shows up
  <a class="heading-link" href="#demon-shows-up">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>At first, I print log messages in an old-fashioned way with <code>console.log(“xxx”)</code>, and the result would show up on the <code>Console</code> panel in the safari workspace. It seems that the script exits in the middle of execution when something strange happens. Trying to narrow down the scope of the strange action, I happen to notice another red error message showing up in the <code>Console</code>, it reads <code>ReferenceError: Can't find variable: structuredClone</code>, and its callstack is also located in the  <code>lib/diagram/mermaid.min.js</code>!</p>
<p>I google this function immediately, <a href="https://stackoverflow.com/questions/73607410/referenceerror-structuredclone-is-not-defined-using-jest-with-nodejs-typesc"  class="external-link" target="_blank" rel="noopener"> the answer at stackoverflow</a> says that this <code>structuredClone</code> doesn’t emerge until Node 17. I guess we found the demon! Because Catalina is quite <em>old</em>, it’s not surprising that the Node version is lower than 17. We just have to replace all occurrences of <code>structuredClone</code>. I try to transplant it with <code>lodash</code>, but I always get error when importing it even after installation with npm.</p>
<p>Recalled that Typora of older version works fine on Catalina, I reads the code of similar functions in Typora 1.4.8. It’s actually using <code>JSON.parse(JSON.stringify(x))</code> instead of <code>structuredClone(x)</code>, which is criticized by the answer at stackoverflow. Hah, but we have no better choices.</p>
<p>Restarting the Typora, and guess what! Drawing graph with mermaid no longer hangs with “Painting Diagram……”!!!</p>
<h3 id="another-bug-before-the-cup">
  Another bug before the cup
  <a class="heading-link" href="#another-bug-before-the-cup">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>When I tries to draw simple flowgraph, it prints another error message in the box, saying <code>ERROR: [Mermaid] Object.hasOwn is not a function. (In 'Object.hasOwn(i,a)', 'Object.hasOwn' is undefined)</code>.</p>
<p>It seems just another manifestation of the incompatibilities. After browsing for answers, I finds that <code>Object.hasOwn</code> seems a convenient and more secure(?) wrapper of <code>Object.hasOwnProperty()</code>, which is used to check where a member of the object is available.</p>
<p>Then the solution is quite straightforward: just replace <code>Object.hasOwn(a,b)</code> to <code>a.hasOwnProperty(b)</code>.</p>
<h2 id="problem">
  Problem
  <a class="heading-link" href="#problem">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>To sum up, the actual problem locates in the old version of node and its dependencies for macOS Catalina, resulting in crashes of certain mermaid js scripts.</p>
<h2 id="solution">
  Solution
  <a class="heading-link" href="#solution">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Edit <code>/Applications/Typora.app/Contents/Resources/TypeMark/lib/diagram/mermaid.min.js</code> if Typora is installed globally, and replace according to the following mapping table:</p>
<table>
<thead>
<tr>
<th>Before</th>
<th>After</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>structuredClone(x)</code> where <code>x</code> is any variable</td>
<td><code>JSON.parse(JSON.stringify(x))</code></td>
</tr>
<tr>
<td><code>Object.hasOwn(a,b)</code> where <code>a</code>,<code>b</code> is any variable</td>
<td><code>a.hasOwnProperty(b)</code></td>
</tr>
</tbody>
</table>
<p>A replaced <code>mermaid.min.js</code> corresponding to 1.8.10 can also be found <a href="./mermaid.min.js" >here</a>.</p>

      </div>


      <footer>
        

<section class="see-also">
  
    
    
    
      <h3 id="see-also-in-catalinaholdout">
        See also in CatalinaHoldout
        <a class="heading-link" href="#see-also-in-catalinaholdout">
          <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
          <span class="sr-only">Link to heading</span>
        </a>
      </h3>
      <nav>
        <ul>
        
        
          
        
          
            <li>
              <a href="/posts/catalinaholdout/000intro/">Introduction to CatalinaHoldout</a>
            </li>
          
        
        </ul>
      </nav>
    
  
</section>


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Xin Xiong 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
